package:
  name: docker-cli-fips
  version: "27.5.0"
  epoch: 0
  description: The Docker CLI
  copyright:
    - license: Apache-2.0

environment:
  contents:
    packages:
      - bash
      - btrfs-progs-dev
      - build-base
      - busybox
      - ca-certificates-bundle
      - containerd
      - coreutils
      - go-fips
      - libseccomp-dev
      - libtool
      - linux-headers
      - lvm2-dev

pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/docker/cli
      tag: v${{package.version}}
      expected-commit: a187fa5d2d0d5f12db920734e425afc758e98ead

  - runs: |
      export DISABLE_WARN_OUTSIDE_CONTAINER=1

      mkdir -p "$GOPATH/src/github.com/docker/"
      ln -sf /home/build "$GOPATH"/src/github.com/docker/cli
      LDFLAGS="" make VERSION=${{package.version}} dynbinary

      install -Dm755 build/docker-linux-* ${{targets.destdir}}/usr/bin/docker

  - runs: |
      make manpages
      install -Dm644 man/man1/* -t ${{targets.destdir}}/usr/share/man/man1/

  # Docker is vehemenetly against stripping the resulting binary
  # Ref: https://github.com/moby/moby/blob/d8a51d2887cbc465ab8d76ed98f7a86996ab3c22/project/PACKAGERS.md#stripping-binaries
  # - uses: strip
  - runs: |
      # this exists to appease yam

subpackages:
  - name: "${{package.name}}-doc"
    description: "${{package.name}} documentation"
    pipeline:
      - uses: split/manpages

update:
  enabled: true
  ignore-regex-patterns:
    - (.*)(beta|rc)(.*) # Ignore beta, and rc releases
  github:
    identifier: docker/cli
    strip-prefix: v
    tag-filter: v
    use-tag: true

test:
  pipeline:
    - uses: test/go-fips-check
    - runs: |
        docker --help
    # AUTOGENERATED
    - runs: |
        docker --version
