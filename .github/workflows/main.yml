  generate-charts:
    runs-on: ubuntu-latest
    needs: process-vulnerabilities

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Enriched Vulnerability Data
        uses: actions/download-artifact@v4
        with:
          name: enriched-vulnerability-data
          path: ./

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests tabulate matplotlib kaleido numpy

      - name: Ensure Charts Directory Exists
        run: mkdir -p charts

      - name: Generate Charts
        run: |
          python scripts/generatecharts.py

      - name: Check Generated Charts
        run: |
          if [ -z "$(ls -A charts)" ]; then
            echo "Error: No charts were generated!"
            exit 1
          fi

      - name: Upload Charts
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-charts
          path: charts/

      - name: Append Chart Insights to GitHub Summary  # ✅ Missing step added here
        run: |
          if [ -f summary.md ]; then
            cat summary.md >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Error: summary.md not found!" >> $GITHUB_STEP_SUMMARY
